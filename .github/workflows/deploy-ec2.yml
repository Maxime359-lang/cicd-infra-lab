name: Deploy Nginx Gateway (SSM + OIDC)

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-nginx-gateway
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: eu-central-1

      - name: Deploy via SSM Run Command
        env:
          SHA: ${{ github.sha }}
          PUB_IP: "18.198.208.36"
        run: |
          set -euo pipefail

          CMD_ID=$(aws ssm send-command \
            --targets "Key=tag:SSMDeploy,Values=prod-automation" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy nginx gateway SHA=${SHA}" \
            --query "Command.CommandId" \
            --output text \
            --parameters commands="[
              \"set -euo pipefail\",
              \"sudo dnf install -y nginx curl >/dev/null 2>&1 || true\",
              \"sudo mkdir -p /var/www/letsencrypt\",
              \"sudo curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${SHA}/nginx/cicd.conf.tpl -o /tmp/cicd.conf.tpl\",
              \"sed 's/<EC2_IP>/${PUB_IP}/g' /tmp/cicd.conf.tpl | sudo tee /etc/nginx/conf.d/cicd.conf >/dev/null\",
              \"sudo nginx -t\",
              \"sudo systemctl enable --now nginx\",
              \"sudo systemctl reload nginx\",
              \"sudo curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${SHA}/scripts/smoke-nginx.sh -o /tmp/smoke-nginx.sh\",
              \"sudo chmod +x /tmp/smoke-nginx.sh\",
              \"bash -lc '/tmp/smoke-nginx.sh ${PUB_IP}'\",
              \"echo OK\"
            ]")

          echo "SSM CommandId: $CMD_ID"

          aws ssm wait command-executed \
            --command-id "$CMD_ID" \
            --instance-id "${{ secrets.AWS_EC2_INSTANCE_ID }}"

          aws ssm get-command-invocation \
            --command-id "$CMD_ID" \
            --instance-id "${{ secrets.AWS_EC2_INSTANCE_ID }}" \
            --query "{Status:Status,Stdout:StandardOutputContent,Stderr:StandardErrorContent,ResponseCode:ResponseCode}" \
            --output json
