name: Deploy Nginx Gateway (SSM + OIDC)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-nginx-gateway
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: eu-central-1

      - name: Deploy via SSM Run Command
        env:
          SHA: ${{ github.sha }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          CMD_ID=$(aws ssm send-command \
            --targets "Key=tag:SSMDeploy,Values=prod-automation" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy nginx gateway SHA=${SHA}" \
            --query "Command.CommandId" \
            --output text \
            --parameters commands="[
              \"set -euo pipefail\",

              \"sudo dnf install -y nginx curl >/dev/null 2>&1 || true\",
              \"sudo mkdir -p /var/www/letsencrypt\",
              \"sudo mkdir -p /opt/cicd-gateway\",

              \"sudo curl -fsSL https://raw.githubusercontent.com/${REPO}/${SHA}/nginx/cicd.conf.tpl -o /opt/cicd-gateway/cicd.conf.tpl\",
              \"sudo curl -fsSL https://raw.githubusercontent.com/${REPO}/${SHA}/scripts/smoke.sh -o /opt/cicd-gateway/smoke.sh\",
              \"sudo chmod +x /opt/cicd-gateway/smoke.sh\",

              \"TOKEN=\\$(curl -sS -X PUT 'http://169.254.169.254/latest/api/token' -H 'X-aws-ec2-metadata-token-ttl-seconds: 60')\",
              \"PUB_IP=\\$(curl -sS -H 'X-aws-ec2-metadata-token: \\$TOKEN' http://169.254.169.254/latest/meta-data/public-ipv4)\",

              \"sudo sed 's/<EC2_IP>/\\$PUB_IP/g' /opt/cicd-gateway/cicd.conf.tpl | sudo tee /etc/nginx/conf.d/cicd.conf >/dev/null\",
              \"sudo nginx -t\",
              \"sudo systemctl enable --now nginx\",
              \"sudo systemctl reload nginx\",

              \"/opt/cicd-gateway/smoke.sh https://cicd-github.\\$PUB_IP.nip.io/health\",
              \"/opt/cicd-gateway/smoke.sh https://cicd-gitlab.\\$PUB_IP.nip.io/health\",

              \"echo OK\"
            ]")

          echo "SSM CommandId: $CMD_ID"

          aws ssm wait command-executed \
            --command-id "$CMD_ID" \
            --instance-id "${{ secrets.AWS_EC2_INSTANCE_ID }}"

          aws ssm get-command-invocation \
            --command-id "$CMD_ID" \
            --instance-id "${{ secrets.AWS_EC2_INSTANCE_ID }}" \
            --query "{Status:Status,Stdout:StandardOutputContent,Stderr:StandardErrorContent,ResponseCode:ResponseCode}" \
            --output json
